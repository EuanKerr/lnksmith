name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/dependency-review-action@05fe4576374b728f0c523d6a13d64c25081e0803 # v4.8.3
        with:
          fail-on-severity: high

  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0

      - run: uv python install ${{ vars.PYTHON_VERSION }}

      - run: uv venv && uv pip install -e ".[dev]"

      - name: Lint
        run: ruff check . && ruff format --check .

      - name: Run tests with coverage
        run: >-
          uv run pytest tests/ -v --tb=short
          --junitxml=TestResults/results.xml
          --cov=src/lnksmith
          --cov-report=xml:coverage.xml

      - name: Test summary
        if: always()
        run: |
          [ -f TestResults/results.xml ] || exit 0
          python3 - TestResults/results.xml >> "$GITHUB_STEP_SUMMARY" << 'PYEOF'
          import sys, xml.etree.ElementTree as ET
          tree = ET.parse(sys.argv[1])
          root = tree.getroot()
          suite = root.find("testsuite") if root.tag == "testsuites" else root
          ts = suite.get("tests", "0")
          fails = suite.get("failures", "0")
          errs = suite.get("errors", "0")
          skip = suite.get("skipped", "0")
          t = suite.get("time", "?")
          print("## Test Results\n")
          print(f"| Metric | Count |")
          print(f"|--------|-------|")
          print(f"| Passed | {int(ts) - int(fails) - int(errs) - int(skip)} |")
          print(f"| Failed | {fails} |")
          print(f"| Errors | {errs} |")
          print(f"| Skipped | {skip} |")
          print(f"| Duration | {t}s |")
          PYEOF

      - name: Coverage summary
        if: always()
        run: |
          [ -f coverage.xml ] || exit 0
          python3 - coverage.xml >> "$GITHUB_STEP_SUMMARY" << 'PYEOF'
          import sys, xml.etree.ElementTree as ET
          tree = ET.parse(sys.argv[1])
          root = tree.getroot()
          rate = float(root.get("line-rate", "0"))
          pct = f"{rate * 100:.1f}%"
          print("\n## Code Coverage\n")
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Line coverage | {pct} |")
          for pkg in root.findall(".//package"):
              name = pkg.get("name", "?")
              lr = float(pkg.get("line-rate", "0"))
              print(f"| {name} | {lr * 100:.1f}% |")
          PYEOF
